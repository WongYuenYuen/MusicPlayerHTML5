"use strict";
(function(b) {
	b("[data-i18n-content]").each(function() {
		var d = chrome.i18n.getMessage(this.getAttribute("data-i18n-content"));
		b(this).html(d);
	});
	b("[data-i18n-placeholder]").each(function() {
		var d = chrome.i18n.getMessage(this.getAttribute("data-i18n-placeholder"));
		b(this).attr("placeholder", d);
	});
	b("[data-i18n-value]").each(function() {
		var d = chrome.i18n.getMessage(this.getAttribute("data-i18n-value"));
		b(this).val(d);
	});
	b("[data-i18n-title]").each(function() {
		var d = chrome.i18n.getMessage(this.getAttribute("data-i18n-title"));
		b(this).attr("title", d);
	});

	function c(g, h, d, i) {
		var e = g.text().split(h),
			f = "";
		if (e.length) {
			b(e).each(function(j, k) {
				f += '<span class="' + d + (j + 1) + '">' + k + "</span>" + i;
			});
			g.empty().append(f);
		}
	}
	var a = {
		init: function() {
			return this.each(function() {
				c(b(this), "", "char", "");
			});
		},
		words: function() {
			return this.each(function() {
				c(b(this), " ", "word", " ");
			});
		},
		lines: function() {
			return this.each(function() {
				var d = "eefec303079ad17405c889e092e105b0";
				c(b(this).children("br").replaceWith(d).end(), d, "line", "");
			});
		}
	};
	b.fn.lettering = function(d) {
		if (d && a[d]) {
			return a[d].apply(this, [].slice.call(arguments, 1));
		} else {
			if (d === "letters" || !d) {
				return a.init.apply(this, [].slice.call(arguments, 0));
			}
		}
		b.error("Method " + d + " does not exist on jQuery.lettering");
		return this;
	};
})(jQuery);
$(".desc-text > h2").lettering("words").children("span").lettering().children("span").lettering();
setTimeout(function() {
	$("#startup").remove();
}, 5100);

function showMsg(a) {
	clearTimeout(window.msgtimer);
	$(".tipmsg").html(a).fadeIn();
	window.msgtimer = setTimeout(function() {
		$(".tipmsg").fadeOut();
	}, 3000);
}

function DnDFileController(a, d) {
	var b = document.querySelector(a);
	var c = 0;
	this.dragenter = function(f) {
		f.stopPropagation();
		f.preventDefault();
		c++;
		b.classList.add("dropping");
	};
	this.dragover = function(f) {
		f.stopPropagation();
		f.preventDefault();
	};
	this.dragleave = function(f) {
		f.stopPropagation();
		f.preventDefault();
		if (--c <= 0) {
			b.classList.remove("dropping");
			c = 0;
		}
	};
	this.drop = function(f) {
		f.stopPropagation();
		f.preventDefault();
		b.classList.remove("dropping");
		d(f.dataTransfer);
	};
	b.addEventListener("dragenter", this.dragenter, false);
	b.addEventListener("dragover", this.dragover, false);
	b.addEventListener("dragleave", this.dragleave, false);
	b.addEventListener("drop", this.drop, false);
}
var enjoyMusic = angular.module("enjoyMusic", []);

function parseLrc(f) {
	var e = f.split(/[\r\n]/),
		g = e.length,
		j = {}, b = [],
		c = 0;
	var l = {
		ti: "",
		ar: "",
		al: ""
	};
	for (; c < g;) {
		var k, d = true,
			h = decodeURIComponent(e[c]),
			a = h.replace(/\[\d*:\d*((\.|\:)\d*)*\]/g, "");
		"ti ar al".replace(/\S+/g, function(i) {
			if (d && l[i] === "") {
				k = h.match(new RegExp("\\[" + i + "\\:(.*?)\\]"));
				if (k && k[1]) {
					d = false;
					l[i] = k[1];
				}
			}
		});
		if (a.length === 0) {
			a = " …… ";
		}
		h.replace(/\[(\d*):(\d*)([\.|\:]\d*)*\]/g, function() {
			var i = arguments[1] | 0,
				m = arguments[2] | 0,
				o = i * 60 + m,
				n = b.push(o * 1000);
			j[b[--n]] = a.trim();
		});
		c++;
	}
	b.sort(function(m, i) {
		return m - i;
	});
	return {
		words: j,
		times: b,
		data: l
	};
}

function renderLrc(m) {
	myaudio.lrcData = m;
	var h = m.words,
		a = m.times,
		c = m.data,
		b = 50,
		j = document.getElementsByClassName("lrcContent")[0];
	var f = a.length,
		d = 0,
		g = "",
		k = 250,
		e = null;
	if (a.length == 0) {
		return;
	}
	for (; d < f; d++) {
		var n = a[d],
			l = h[n];
		if (n != e) {
			g += '<p data-lrctime="' + n + '" data-lrctop="' + k + '">' + l + "</p>";
			k -= b;
		}
		e = n;
	}
	j.innerHTML = g;
	j.style.marginTop = "250px";
	j.querySelectorAll("p")[0].classList.add("cur");
}
var loadImage = function(a, c) {
	var b = new XMLHttpRequest();
	b.responseType = "blob";
	b.onload = function() {
		c(window.webkitURL.createObjectURL(b.response), a);
	};
	b.open("GET", a, true);
	b.send();
};
var mediaData = [];
var mediaDirIndex = 0;
var mediaReader = null;
var meidaDirectories = [];
var myaudio = audio.createPlayer();

function getmediaById(a, d) {
	for (var b = 0; b < a.length; b++) {
		var c = chrome.mediaGalleries.getMediaFileSystemMetadata(a[b]);
		if (c.galleryId == d) {
			return a[b];
		}
	}
	return false;
}
var tj_service, tj_tracker;

function MusicListCtrl(l, q) {
	function f(V) {
		var U = document.getElementsByClassName("lrcContent")[0];
		U.innerHTML = "<p>" + chrome.i18n.getMessage("searchlrc"); + "</p>";
		U.style.marginTop = "250px";
		if (V.lrc && V.lrc != "http://ting.baidu.com" && V.lrc != "http://music.baidu.com") {
			var X = new XMLHttpRequest();
			X.responseType = "text";
			X.onload = function() {
				renderLrc(parseLrc(X.response));
			};
			var W = V.lrc;
			if (W.indexOf("/data2/") == 0) {
				W = "http://ting.baidu.com" + W;
			}
			X.open("GET", W, true);
			X.send();
			return;
		}
		var T = "http://tingapi.ting.baidu.com/v1/restserver/ting?method=baidu.ting.search.common&format=jsonp&page_no=1&page_size=1&query=" + encodeURIComponent(V.title.replace("/", " ").replace("-", " "));
		q({
			method: "GET",
			url: V.artist == "unknown" ? T : T + " " + encodeURIComponent(V.artist.split("/")[0].trim())
		}).success(function(Z, Y) {
			if (Z.song_list.length > 0) {
				q({
					method: "GET",
					url: "http://ting.baidu.com/data/music/songlink?type=mp3&speed=&songIds=" + Z.song_list[0].song_id
				}).success(function(ab, aa) {
					ab.data.songList;
					if (ab.errorCode == 22000) {
						var ac = new XMLHttpRequest();
						ac.responseType = "text";
						ac.onload = function() {
							renderLrc(parseLrc(ac.response));
						};
						if (ab.data.songList[0] != "") {
							ac.open("GET", "http://ting.baidu.com" + ab.data.songList[0].lrcLink, true);
							ac.send();
						}
					}
				});
			} else {
				U.innerHTML = "<p>" + chrome.i18n.getMessage("nolrc"); + "</p>";
				U.style.marginTop = "250px";
			}
		});
	}

	function i(T, W) {
		for (var U = 0; U < T.length; U++) {
			var V = chrome.mediaGalleries.getMediaFileSystemMetadata(T[U]);
			if (V.galleryId == W) {
				return T[U];
			}
		}
	}
	window.scanMusicList = [];
	var H = 0;
	var M = new Worker("js/add-worker.js");
	var K = new Worker("js/add-worker.js");
	Q(M);
	Q(K);

	function Q(T) {
		T.onmessage = function(U) {
			var V = U.data;
			$.indexedDB("MusicDb").objectStore("musiclist").add(V);
			g(T);
			H++;
			l.progress.current = H;
			document.getElementById("addProgress").value = H;
			if (H % 5 === 0) {
				k();
			}
		};
		T.onerror = function(U) {
			g(T);
			H++;
		};
	}
	var u = null;

	function g(V) {
		if (scanMusicList.length > 0) {
			var T = scanMusicList.shift();
			var U = i(mediaData, T.mediaId);
			if (U) {
				document.getElementById("addedResult").innerHTML = chrome.i18n.getMessage("analysismusic") + T.path;
				U.root.getFile(T.path, {
					create: false
				}, function(W) {
					if (!A(T.mediaId, T.path)) {
						W.file(function(X) {
							if ((X.type == "audio/mp3" || X.type == "audio/x-m4a" || X.type == "audio/wav") && !A(T.mediaId, T.path)) {
								T.file = X;
								V.postMessage(T);
								T = null;
							} else {
								g(V);
								H++;
							}
						}, function(X) {
							g(V);
							H++;
						});
					} else {
						g(V);
						H++;
					}
				}, function(W) {
					g(V);
					H++;
				});
			} else {
				g(V);
				H++;
			}
		} else {
			clearTimeout(u);
			l.progress.show = false;
			document.getElementById("addProgress").value = H;
			k();
			mediaDirIndex = 0;
			u = setTimeout(function() {}, 10000);
		}
	}
	l.progress = {
		total: 0,
		show: false,
		current: 0
	};

	function A(T, V) {
		var W = l.songs;
		for (var U = 0; U < W.length; U++) {
			if (W[U].mediaId == T && W[U].path == V) {
				return true;
			}
		}
		return false;
	}

	function e(T) {
		var U = ["m4a", "mp3", "wav"];
		var V = T.substr(T.lastIndexOf(".") + 1).toLowerCase();
		if (U.indexOf(V) >= 0) {
			return true;
		} else {
			return false;
		}
	}

	function h(T) {
		var W = chrome.mediaGalleries.getMediaFileSystemMetadata(mediaData[mediaDirIndex]);
		for (var V = 0; V < T.length; V++) {
			if (T[V].isFile) {
				var U = T[V].fullPath;
				if (e(U)) {
					scanMusicList.push({
						mediaId: W.galleryId,
						path: U,
						cover: false
					});
				}
			} else {
				if (T[V].isDirectory) {
					meidaDirectories.push(T[V]);
				} else {}
			}
		}
		if (meidaDirectories.length > 0) {
			var X = meidaDirectories.shift();
			mediaReader = X.createReader();
			mediaReader.readEntries(h);
		} else {
			mediaDirIndex++;
			if (mediaDirIndex < mediaData.length) {
				C(mediaData[mediaDirIndex]);
			} else {
				l.progress.total = scanMusicList.length;
				l.$apply(function(Y) {});
				g(M);
				g(K);
			}
		}
	}

	function C(T) {
		mediaReader = T.root.createReader();
		mediaReader.readEntries(h);
	}
	l.addLocalMusic = {
		isshow: false,
		open: function() {
			$(".add_dialog").addClass("opened");
			this.isshow = true;
		},
		close: function() {
			$(".add_dialog").removeClass("opened");
			this.isshow = false;
			k();
		},
		changeLocation: function() {
			chrome.mediaGalleries.getMediaFileSystems({
				interactive: "yes"
			}, function(T) {
				mediaData = T;
				mediaData = T;
				B(mediaData);
			});
		},
		addLocalMusic: function() {
			if (mediaData.length < 1) {
				k();
				return;
			}
			scanMusicList = [];
			H = 0;
			l.progress.show = true;
			C(mediaData[mediaDirIndex]);
			this.close();
			if (l.$root.$$phase != "$apply" && l.$root.$$phase != "$digest") {
				l.$apply();
			}
			tj_tracker.sendEvent("add", "addLocalMusic");
		}
	};
	l.playOnlineMusic = function(W, T, V) {
		var U = T;
		f(U);
		l.current.track = T;
		l.current.from = V;
		l.current.track.picture = U.image.large;
		loadImage(U.image.large, function(Y, X) {
			if (U.image.large == X) {
				$(".cover-img ").attr("src", Y);
			}
		});
		if (U.url.indexOf("soundcloud.com") > -1) {
			myaudio.setSrc(U.url + "?consumer_key=leL50hzZ1H8tAdKCLSCnw");
		} else {
			myaudio.setSrc(U.url);
		}
		myaudio.play();
		l.current.ispause = false;
		N(U);
	};
	l.playMusicOnline = function(W, T, V) {
		var U = T;
		f(U);
		l.current.track = T;
		l.current.from = V;
		loadImage(U.picture, function(Y, X) {
			if (U.picture == X) {
				$(".cover-img ").attr("src", Y);
			}
		});
		myaudio.setSrc(U.url);
		myaudio.play();
		l.current.ispause = false;
		N(U);
	};
	var R = null;
	var b = null;
	var D = null;
	var j = new QRCode("qrcode", {
		width: 128,
		height: 128,
	});

	function N(U) {
		if (D) {
			var T = {
				tid: D,
				cid: R,
				type: "playing"
			};
			T.song = U;
			b.emit("control", T);
		}
	}
	l.remote = function() {
		if (!b) {
			b = io.connect("https://music-zhigui.rhcloud.com:8443", {
				secure: true
			});
			b.on("connected", function(T) {
				R = T.id;
				j.clear();
				j.makeCode("https://music-zhigui.rhcloud.com?tid=" + R + "&lang=" + chrome.i18n.getMessage("lang"));
				document.getElementById("remote-tip").innerHTML = chrome.i18n.getMessage("remote_scan") || "请用手机扫描二维码，在手机浏览器中打开二维码中的链接！";
			});
			b.on("doit", function(V) {
				var U = V.type;
				switch (U) {
					case "prev":
						l.playprev();
						break;
					case "next":
						l.playnext();
						break;
					case "playPause":
						l.playPause();
						break;
					case "conn_ok":
						D = V.cid;
						document.getElementById("remote-tip").innerHTML = chrome.i18n.getMessage("remote_success") || "远程遥控配对成功！";
						b.emit("control", {
							tid: D,
							cid: R,
							type: "volume",
							volume: l.volume.value
						});
						break;
					case "conn_error":
						document.getElementById("remote-tip").innerHTML = chrome.i18n.getMessage("remote_failure") || "远程遥控配对失败！";
						break;
					case "volume":
						var T = V.volume;
						l.volume.value = T;
						myaudio.setVolume(T);
						if (T == 0) {
							myaudio.audioEl.muted = true;
							l.volume.muted = true;
						} else {
							myaudio.audioEl.muted = false;
							l.volume.muted = false;
						}
						break;
				}
				l.$apply(function(W) {});
				tj_tracker.sendEvent("remote", "socket", U);
			});
			tj_tracker.sendEvent("remote", "open");
		}
	};
	l.qrcode = {
		isshow: false,
		pop: function() {
			this.isshow = true;
			l.remote();
		},
		close: function() {
			this.isshow = false;
		}
	};
	l.setting = {
		isshow: false,
		lastquality: 128,
		pop: function() {
			this.isshow = true;
			tj_tracker.sendEvent("setting", "open");
			this.lastquality = this.options.quality;
		},
		close: function() {
			this.isshow = false;
			tj_tracker.sendEvent("setting", "close");
		},
		ok: function() {
			this.isshow = false;
			chrome.storage.local.set({
				setting: this.options
			});
			if (this.options.quality != this.lastquality) {
				var V = l.current.from;
				if (V && V.indexOf("fm") > -1) {
					var U = l.current[V];
					var T = U.indexOf(l.current.track);
					showMsg("音乐电台音乐质量已经更改，歌曲码率即将切换");
					y(function() {
						l.playMusicOnline(T, l.fmSongs[T], "fmSongs");
					});
				}
			}
			tj_tracker.sendEvent("setting", "ok", "notify", this.options.notify ? 1 : 0);
		},
		options: {
			notify: true,
			quality: 128
		}
	};
	l.volume = {
		value: 1,
		muted: myaudio.audioEl.muted,
		change: function() {
			myaudio.setVolume(this.value);
			if (this.value == 0) {
				myaudio.audioEl.muted = true;
				this.muted = true;
			} else {
				myaudio.audioEl.muted = false;
				this.muted = false;
			}
			clearTimeout(window.volumeTimer);
			window.volumeTimer = setTimeout(function() {
				if (b) {
					b.emit("control", {
						tid: D,
						cid: R,
						type: "volume",
						volume: l.volume.value
					});
				}
				tj_tracker.sendEvent("control", "volume", "volume", l.volume.value);
			}, 300);
		},
		mute: function() {
			myaudio.audioEl.muted = !myaudio.audioEl.muted;
			this.muted = myaudio.audioEl.muted;
			if (!this.muted && this.value == 0) {
				this.value = 0.5;
				myaudio.setVolume(this.value);
			}
		}
	};
	l.shareWith = function() {
		tj_tracker.sendEvent("control", "share");
	};
	var t = 0;
	var n = true;
	window.onblur = function() {
		n = false;
	};
	window.onfocus = function() {
		n = true;
	};
	chrome.notifications.onButtonClicked.addListener(E);
	chrome.notifications.onClicked.addListener(function() {
		chrome.app.window.current().focus();
	});

	function E(U, T) {
		if (T == 0) {
			l.playnext();
		}
	}

	function L(U) {
		if (l.setting.options.notify) {
			if (n) {
				return;
			}
			var T = {
				type: "basic",
				title: U.title,
				message: chrome.i18n.getMessage("song_artist") + ":" + U.artist + "\n" + chrome.i18n.getMessage("song_album") + ":" + U.album,
				iconUrl: U.picture ? "images/default_logo.png" : "images/default_logo.png",
				buttons: [{
					title: chrome.i18n.getMessage("skipnext")
				}]
			};
			t++;
			(function(V) {
				setTimeout(function() {
					chrome.notifications.clear(V, function() {});
				}, 10000);
			})("id" + t);
			chrome.notifications.create("id" + t, T, a);
			if (U.picture) {
				loadImage(U.picture, function(W, V) {
					if (U.picture == V) {
						T.iconUrl = W;
						chrome.notifications.update("id" + t, T, a);
					}
				});
			}
		}
	}

	function a(T) {}
	l.current = {};
	l.current.default_tip = (chrome.i18n.getMessage("default_tip") || "享受音乐，享受生活！");
	l.playprev = function(U) {
		var X = l.current.from;
		var V = l.current[X];
		var T = V.indexOf(l.current.track);
		if (T > 0) {
			T--;
			var W = V[T];
			if (X.indexOf("online") > -1) {
				l.playOnlineMusic(T, W, X);
			} else {
				if (X.indexOf("searchResult") > -1) {
					l.playMusicOnline(T, W, X);
				} else {
					if (X.indexOf("channel") > -1 || X.indexOf("fm") > -1) {
						l.playMusicOnline(T, W, X);
					} else {
						if (l.playMode.code == 2) {
							T = Math.floor(Math.random() * (V.length - 1));
							W = V[T];
						}
						if (X.indexOf("download") > -1) {
							l.playOffline(W.filepath, W, X);
						} else {
							l.playMusic(W.id, W, X);
						}
					}
				}
			}
		}
		tj_tracker.sendEvent("control", "playprev", X);
	};
	l.playnext = function(V) {
		var X = l.current.from;
		var W = l.current[X];
		if (!W) {
			W = [];
		}
		var T = W.indexOf(l.current.track);
		if (T < W.length - 1) {
			T++;
			var U = W[T];
			if (X.indexOf("online") > -1) {
				l.playOnlineMusic(T, U, X);
			} else {
				if (X.indexOf("searchResult") > -1) {
					l.playMusicOnline(T, U, X);
				} else {
					if (X.indexOf("channel") > -1 || X.indexOf("fm") > -1) {
						l.playMusicOnline(T, U, X);
					} else {
						if (l.playMode.code == 2) {
							T = Math.floor(Math.random() * (W.length - 1));
							U = W[T];
						}
						if (X.indexOf("download") > -1) {
							l.playOffline(U.filepath, U, X);
						} else {
							l.playMusic(U.id, U, X);
						}
					}
				}
			}
			L(U);
		} else {
			if (X.indexOf("channel") > -1) {
				l.playChanel(l.current.channelId);
			}
			if (X.indexOf("fm") > -1) {
				l.playFM(l.current.channelId);
			}
		}
		tj_tracker.sendEvent("control", "playnext", X);
	};
	l.playPause = function() {
		if (myaudio.audioEl.paused) {
			myaudio.play();
			l.current.ispause = false;
			tj_tracker.sendEvent("control", "play");
		} else {
			myaudio.pause();
			l.current.ispause = true;
			tj_tracker.sendEvent("control", "pause");
		}
	};
	l.playOffline = function(U, T, V) {
		l.current.track = T;
		l.current.from = V;
		f(T);
		v.readFileAsUrl(U, function(W, X) {
			myaudio.setSrc(X);
			myaudio.play();
			l.current.ispause = false;
			l.current.track = T;
			l.$apply(function(Y) {});
			if (T.picture && window.navigator.onLine) {
				loadImage(T.picture, function(Z, Y) {
					if (T.picture == Y) {
						$(".cover-img ").attr("src", Z);
					}
				});
			} else {
				$(".cover-img ").attr("src", "images/default_disk.png");
			}
		});
	};
	l.playMusic = function(X, T, W) {
		f(T);
		l.current.track = T;
		l.current.from = W;
		var V = T;
		var U = i(mediaData, V.mediaId);
		if (U) {
			U.root.getFile(V.path, {
				create: false
			}, function(Y) {
				Y.file(function(Z) {
					myaudio.setSrc(window.webkitURL.createObjectURL(Z));
					myaudio.play();
					var aa = new Worker("js/add-worker.js");
					aa.postMessage({
						file: Z,
						mediaId: null,
						path: null,
						cover: true
					});
					aa.onmessage = function(ab) {
						var ac = ab.data.picture;
						if (ac) {
							if (ac.indexOf("/9j/") == -1) {
								$(".cover-img ").attr("src", "data:image/jpeg;base64,/9j/4AAQSkZJRgAB" + ac);
							} else {
								$(".cover-img ").attr("src", "data:image/jpeg;base64," + ac);
							}
						} else {
							$(".cover-img ").attr("src", "images/default_disk.png");
						}
					};
				});
			});
		}
		T.playCount = T.playCount + 1;
		l.current.ispause = false;
		$.indexedDB("MusicDb").objectStore("musiclist").put(T);
		N(V);
	};
	l.lrc = {
		switchlrc: function() {
			if (this.open) {
				this.style = {
					"-webkit-transform": "translateX(120%)",
				};
				this.open = false;
				myaudio.lrcStatus = false;
				setTimeout(function() {
					$("#lrcWarp").hide().show();
				}, 500);
				tj_tracker.sendEvent("lrc", "close");
			} else {
				this.style = {
					"-webkit-transform": "translateX(0)"
				};
				this.open = true;
				myaudio.lrcStatus = true;
				tj_tracker.sendEvent("lrc", "open");
			}
		},
		style: {},
		open: false
	};
	l.fullscreen = {
		status: chrome.app.window.current().isFullscreen(),
		fullswitch: function() {
			if (chrome.app.window.current().isFullscreen()) {
				chrome.app.window.current().restore();
			} else {
				chrome.app.window.current().fullscreen();
			}
			tj_tracker.sendEvent("control", "fullscreen");
		}
	};
	l.tab = {
		top: {
			select: 0
		},
		sub: {
			select: 0
		},
		online: {
			select: 0
		},
		artist: null,
		album: null,
		showTab: function(T) {
			this.top.select = T;
			tj_tracker.sendEvent("tab", "top", T);
		},
		showSubTab: function(T) {
			this.sub.select = T;
			tj_tracker.sendEvent("tab", "sub", T);
		},
		showOnlineTab: function(T) {
			this.online.select = T;
			tj_tracker.sendEvent("tab", "online", T);
		}
	};
	l.searchResult = [];
	l.search = {
		keyword: "",
		change: function() {
			if (this.keyword.trim().length === 0) {
				return;
			}
			clearTimeout(window.searchTimeout);
			var T = this;
			window.searchTimeout = setTimeout(function() {
				if (window.navigator.language != "zh-CN" && window.navigator.language != "zh_TW") {
					var U = "http://ex.fm/api/v3/song/search/" + T.keyword;
					q({
						method: "GET",
						url: U
					}).success(function(Y, W) {
						if (Y.status_code == 200) {
							l.tab.showTab(1);
							l.tab.showOnlineTab(1);
							var V = [];
							for (var X = 0; X < Y.songs.length; X++) {
								var Z = {
									title: decodeURIComponent(Y.songs[X].title),
									artist: decodeURIComponent(Y.songs[X].artist),
									album: decodeURIComponent(Y.songs[X].album),
									picture: Y.songs[X].image.large,
									url: Y.songs[X].url
								};
								V.push(Z);
							}
							l.searchResult = V;
						}
					}).error(function(W, V) {});
				} else {
					var U = "http://song4u.sinaapp.com/api/search.php?keyword=" + T.keyword;
					q({
						method: "GET",
						url: U
					}).success(function(V, X) {
						var Z = V.songs;
						if (typeof Z != "object") {
							return;
						}
						l.tab.showTab(1);
						l.tab.showOnlineTab(1);
						var W = [];
						for (var Y = 0; Y < Z.length; Y++) {
							var aa = {
								title: decodeURIComponent(Z[Y].songName).replace("&#039;", "'"),
								artist: decodeURIComponent(Z[Y].artistName).replace("&#039;", "'"),
								album: decodeURIComponent(Z[Y].albumName).replace("&#039;", "'"),
								picture: Z[Y].songPicBig,
								url: Z[Y].songLink,
								lrc: Z[Y].lrcLink
							};
							W.push(aa);
						}
						l.searchResult = W;
					}).error(function(W, V) {
						showMsg("啊哦！搜索歌曲出错 T T ");
					});
				}
			}, 600);
		}
	};
	chrome.app.window.current().onBoundsChanged.addListener(function() {
		l.fullscreen.status = chrome.app.window.current().isFullscreen();
		l.$apply(function(T) {});
	});
	$.indexedDB("MusicDb", {
		schema: {
			"1": function(U) {
				var T = U.createObjectStore("musiclist", {
					keyPath: "id",
					autoIncrement: false
				});
				T.createIndex("artist");
				T.createIndex("album");
				T.createIndex("title");
			}
		}
	}).done(function() {});
	$.indexedDB("offlineDb", {
		schema: {
			"1": function(U) {
				var T = U.createObjectStore("musiclist", {
					keyPath: "id",
					autoIncrement: true
				});
				T.createIndex("artist");
				T.createIndex("album");
				T.createIndex("title");
			}
		}
	}).done(function() {});
	chrome.mediaGalleries.getMediaFileSystems({
		interactive: "no"
	}, function(T) {
		mediaData = T;
		B(mediaData);
		k();
	});
	var x = [];
	var c = {};
	var r = {};
	var m = [];
	var z = false;

	function k() {
		if (z) {
			return;
		}
		z = true;
		x = [];
		c = {};
		r = {};
		var U = [];
		for (var T = 0; T < mediaData.length; T++) {
			U.push(chrome.mediaGalleries.getMediaFileSystemMetadata(mediaData[T]).galleryId);
		}
		$.indexedDB("MusicDb").objectStore("musiclist").each(function(V) {
			if (U.indexOf(V.value.mediaId) == -1) {
				V.delete();
			} else {
				var W = V.value;
				x.push(W);
				if (!c[W.artist]) {
					c[W.artist] = [];
					c[W.artist].push(W);
				} else {
					c[W.artist].push(W);
				} if (!r[W.album]) {
					r[W.album] = [];
					r[W.album].push(W);
				} else {
					r[W.album].push(W);
				}
			}
		}).done(function() {
			l.songs = x;
			l.artists = c;
			l.albums = r;
			l.$apply(function(V) {});
			z = false;
		});
	}
	l.showSongsByArtist = function(T) {
		l.artist_songs = c[T];
		l.tab.artist = T;
	};
	l.showSongsByAlbum = function(T) {
		l.album_songs = r[T];
		l.tab.album = T;
	};
	l.playMode = {};
	l.playMode.code = 0;
	l.playMode.icon = "&#xe021;";
	l.playMode.title = chrome.i18n.getMessage("mode_list") || "列表播放";
	l.togglePlayMode = function() {
		var T = l.playMode.code;
		if (T < 2) {
			T++;
		} else {
			T = 0;
		}
		switch (T) {
			case 0:
				l.playMode.code = 0;
				l.playMode.icon = "&#xe021;";
				l.playMode.title = chrome.i18n.getMessage("mode_list") || "列表播放";
				myaudio.unsetLoop();
				break;
			case 1:
				l.playMode.code = 1;
				l.playMode.icon = "&#xe00d;";
				l.playMode.title = chrome.i18n.getMessage("mode_single") || "单曲循环";
				myaudio.setLoop();
				break;
			case 2:
				l.playMode.code = 2;
				l.playMode.icon = "&#xe01f;";
				l.playMode.title = chrome.i18n.getMessage("mode_random") || "随机播放";
				myaudio.unsetLoop();
		}
		tj_tracker.sendEvent("control", "playmode", T.toString());
	};
	myaudio.onEndedHandle = function() {
		var W = l.playMode.code;
		switch (W) {
			case 0:
				l.playnext();
				break;
			case 1:
				break;
			case 2:
				var X = l.current.from;
				if (X.indexOf("channel") > -1) {
					l.playnext();
				} else {
					var V = l.current[X];
					var T = Math.floor(Math.random() * (V.length - 1));
					var U = V[T];
					if (X.indexOf("online") > -1) {
						l.playOnlineMusic(T, U, X);
					} else {
						if (X.indexOf("download") > -1) {
							l.playOffline(U.filepath, U, X);
						} else {
							l.playMusic(U.id, U, X);
						}
					}
				}
		}
		l.$apply(function(Y) {});
	};
	var p = 0;
	var w = [];
	l.download = function(U) {
		l.tab.showTab(0);
		l.tab.showSubTab(5);
		U.filepath = U.title + new Date().getTime() + ".mp3";
		U.download = true;
		var T = new d(U.url, U, p);
		w[p] = T;
		p++;
	};
	l.emptyOffline = function() {
		v.wipe(function() {
			S.root.getDirectory(s, {
				create: true
			}, function(T) {
				P = T;
			});
			$.indexedDB("offlineDb").objectStore("musiclist").clear().done(function() {
				F();
			});
		}, false);
	};
	l.deleteOfflineSong = function(T) {
		v.remove(T.filepath, function(U) {
			$.indexedDB("offlineDb").objectStore("musiclist").delete(T.id).done(function() {
				F();
			});
		});
	};
	var S;

	function o(T) {
		var U = "";
		switch (T.code) {
			case FileError.QUOTA_EXCEEDED_ERR:
				U = "QUOTA_EXCEEDED_ERR";
				break;
			case FileError.NOT_FOUND_ERR:
				U = "NOT_FOUND_ERR";
				break;
			case FileError.SECURITY_ERR:
				U = "SECURITY_ERR";
				break;
			case FileError.INVALID_MODIFICATION_ERR:
				U = "INVALID_MODIFICATION_ERR";
				break;
			case FileError.INVALID_STATE_ERR:
				U = "INVALID_STATE_ERR";
				break;
			default:
				U = "Unknown Error";
				break;
		}
		console.log("Error: " + U);
	}
	var J = 1024 * 1024 * 1024;
	var P;
	var s = "offline";
	window.StorageInfo = window.navigator.webkitPersistentStorage || window.StorageInfo || window.webkitStorageInfo;
	window.StorageInfo.queryUsageAndQuota(function(U, T) {
		if (J > T) {
			J = T / 3;
		}
		l.space.total = Number((J / 1024 / 1024).toFixed(2));
		window.webkitRequestFileSystem(PERSISTENT, J, function(V) {
			S = V;
			V.root.getDirectory(s, {
				create: true
			}, function(W) {
				P = W;
			});
		}, o);
	});
	var v = {
		writeFile: function(V, U, T) {
			S.root.getFile(s + "/" + V, {
				create: true
			}, function(W) {
				W.createWriter(function(X) {
					X.onwriteend = function(Y) {
						console.log("Write completed.");
						T();
					};
					X.onerror = function(Y) {
						console.log("Write failed: " + Y.toString());
					};
					X.write(U);
				});
			});
		},
		remove: function(U, T) {
			S.root.getFile(s + "/" + U, {
				create: false
			}, function(V) {
				V.remove(function() {
					T();
				});
			});
		},
		readFileAsUrl: function(U, T) {
			S.root.getFile(s + "/" + U, {}, function(V) {
				V.file(function(X) {
					var W = window.webkitURL.createObjectURL(X);
					T(null, W);
				});
			});
		},
		wipe: function(T) {
			P.removeRecursively(function() {
				T();
			});
		}
	};
	var d = function(X, W, U) {
		var V = this;
		var Z = W.filepath;
		delete W.id;
		var T = $('<li><div><span class="delete" >&#xe008;</span>' + W.title + "</div><div>" + W.artist + '</div><div><progress   max="100" value="0"></progress></div></li>');
		var Y = $(".downloading").prepend(T);
		this.xhr = new XMLHttpRequest();
		this.xhr.open("GET", X);
		this.xhr.responseType = "blob";
		T.find(".delete").bind("click", function() {
			V.xhr.abort();
			T.remove();
			W.download = false;
			var aa = delete w[U];
			l.$apply(function(ab) {});
		});
		this.xhr.onload = function() {
			var ab = this.response.size;
			if (l.space.usedspace + this.response.size > J) {
				showMsg(chrome.i18n.getMessage("outofspace"));
				T.remove();
				var aa = delete w[U];
				W.download = false;
				F();
				return;
			}
			v.writeFile(Z, this.response, function(ac) {
				W.datetime = new Date().getTime();
				W.size = ab;
				$.indexedDB("offlineDb").objectStore("musiclist").put(W).done(function(ad, ae) {
					T.remove();
					var ad = delete w[U];
					F();
				});
			});
		};
		this.xhr.onprogress = function(aa) {
			T.find("progress").attr({
				max: aa.totalSize,
				value: aa.loaded
			});
		};
		this.xhr.send();
	};
	l.space = {
		total: J / 1024 / 1024,
		used: 0,
		usedspace: 0,
		leftspace: 0
	};
	l.downloadSong = [];

	function F() {
		l.downloadSong = [];
		$.indexedDB("offlineDb").objectStore("musiclist").each(function(T) {
			var U = T.value;
			l.downloadSong.push(U);
		}).done(function() {
			l.downloadSong.reverse();
			l.current.downloadSong = l.downloadSong;
			window.StorageInfo.queryUsageAndQuota(function(T) {
				l.space.usedspace = T;
				l.space.used = (T / 1024 / 1024).toFixed(2);
				l.space.leftspace = (l.space.total - (T / 1024 / 1024)).toFixed(2);
				l.$apply();
			});
		});
	}
	l.likeIt = function(T) {
		T.favorite = !T.favorite;
		$.indexedDB("MusicDb").objectStore("musiclist").put(T);
	};
	l.dislike = function(T) {
		T.removed = true;
		l.artists[T.artist][l.artists[T.artist].indexOf(T)] = T;
		l.albums[T.album][l.albums[T.album].indexOf(T)] = T;
		$.indexedDB("MusicDb").objectStore("musiclist").put(T);
	};
	l.undislike = function(T) {
		T.removed = false;
		l.artists[T.artist][l.artists[T.artist].indexOf(T)] = T;
		l.albums[T.album][l.albums[T.album].indexOf(T)] = T;
		$.indexedDB("MusicDb").objectStore("musiclist").put(T);
	};
	l.noremovefilterFn = function(T) {
		if (T.removed == false || typeof T.removed == "undefined") {
			return true;
		}
		return false;
	};
	l.removefilterFn = function(T) {
		if (T.removed == false || typeof T.removed == "undefined") {
			return false;
		}
		return true;
	};
	l.channels = [];
	l.fms = [];
	if (chrome.i18n.getMessage("lang") != "CN" || (window.navigator.language != "zh-CN" && window.navigator.language != "zh_TW")) {
		var O = {
			channels: [{
				name: "indie",
				channel_id: "indie"
			}, {
				name: "electronica",
				channel_id: "electronica"
			}, {
				name: "pop",
				channel_id: "pop"
			}, {
				name: "rock",
				channel_id: "rock"
			}, {
				name: "hip-hop",
				channel_id: "hip-hop"
			}, {
				name: "folk",
				channel_id: "folk"
			}, {
				name: "blues",
				channel_id: "blues"
			}, {
				name: "metal",
				channel_id: "metal"
			}, {
				name: "reggae",
				channel_id: "reggae"
			}, {
				name: "jazz",
				channel_id: "jazz"
			}, {
				name: "classical",
				channel_id: "classical"
			}, {
				name: "soul",
				channel_id: "soul"
			}, {
				name: "experimental",
				channel_id: "experimental"
			}, {
				name: "house",
				channel_id: "house"
			}, {
				name: "dubstep",
				channel_id: "dubstep"
			}, {
				name: "chillwave",
				channel_id: "chillwave"
			}, {
				name: "shoegaze",
				channel_id: "shoegaze"
			}, {
				name: "punk",
				channel_id: "punk"
			}, {
				name: "country",
				channel_id: "country"
			}, {
				name: "synthpop",
				channel_id: "synthpop"
			}, {
				name: "mashup",
				channel_id: "mashup"
			}]
		};
		l.channels = O.channels;
	} else {
		$(".forchina").show();
		q({
			method: "GET",
			url: "http://fm.baidu.com/dev/api/?tn=channellist&_=" + new Date().getTime()
		}).success(function(U, T) {
			l.fms = U.channel_list;
		}).error(function(U, T) {
			showMsg("获取电台列表失败，请稍后重启播放器重试");
		});
	}
	l.fmSongs = [];
	var G = "";
	l.playFM = function(T) {
		l.current.channelId = T;
		var U = "http://fm.baidu.com/dev/api/?tn=playlist&id=" + T + "&_=" + new Date().getTime();
		q({
			method: "GET",
			url: U
		}).success(function(Z, V) {
			var Y = Z.list;
			var W = [];
			for (var X = 0; X < 10; X++) {
				if (Y[X]) {
					W.push(Y[X].id);
				}
			}
			G = W.join(",");
			y(function() {
				l.playMusicOnline(0, l.fmSongs[0], "fmSongs");
			});
		});
		tj_tracker.sendEvent("radio", "fm_id", T + "");
	};

	function y(T) {
		q({
			method: "GET",
			url: "http://music.baidu.com/data/music/fmlink?rate=" + l.setting.options.quality + "&songIds=" + G + "&_=" + new Date().getTime()
		}).success(function(U, V) {
			if (U.errorCode = 22000) {
				var Y = [];
				for (var W = 0; W < U.data.songList.length; W++) {
					var X = U.data.songList[W];
					var Z = {
						title: X.songName,
						artist: X.artistName,
						album: X.albumName,
						picture: X.songPicRadio,
						url: X.songLink,
						lrc: X.lrcLink == "" ? "http://fm.baidu.com" + X.lrcLink : null
					};
					Y.push(Z);
				}
				l.fmSongs = Y;
				l.current.fmSongs = Y;
				if (typeof T == "function") {
					T();
				}
			}
		});
	}
	l.channelSongs = [];
	l.playChanel = function(T) {
		l.current.channelId = T;
		var U = "http://ex.fm/api/v3/explore/" + T + "?start=0&results=40";
		q({
			method: "GET",
			url: U
		}).success(function(Y, V) {
			var X = [];
			for (var W = 0; W < Y.songs.length; W++) {
				var Z = {
					title: Y.songs[W].title,
					artist: Y.songs[W].artist,
					album: Y.songs[W].album,
					picture: Y.songs[W].image.large,
					url: Y.songs[W].url
				};
				X.push(Z);
			}
			l.channelSongs = X;
			l.current.channelSongs = X;
			l.playMusicOnline(0, X[0], "channelSongs");
		});
		tj_tracker.sendEvent("radio", "channel_id", T + "");
	};
	q({
		method: "GET",
		url: "http://ex.fm/api/v3/trending"
	}).success(function(U, T) {
		l.trending = U.songs;
	});

	function B(T) {
		if (T.length) {
			var U = "<ul>";
			T.forEach(function(X, W, V) {
				var Y = chrome.mediaGalleries.getMediaFileSystemMetadata(X);
				if (Y) {
					U += "<li>" + Y.name + "</li>";
				}
			});
			U += "</ul>";
			document.getElementById("gallery_location").innerHTML = U;
			document.getElementById("scan-button").disabled = "";
		} else {
			document.getElementById("gallery_location").innerHTML = "<ul><li>" + chrome.i18n.getMessage("addlocalmusicnull") + "</li></ul>";
			document.getElementById("scan-button").disabled = "disabled";
		}
	}

	function I() {
		function T(X, W) {
			if (typeof X[W] != "undefined") {
				l.setting.options[W] = X[W];
			}
		}
		chrome.storage.local.get("setting", function(W) {
			if (typeof W.setting == "undefined") {
				chrome.storage.local.set({
					setting: l.setting.options
				});
			} else {
				T(W.setting, "notify");
				T(W.setting, "quality");
				l.$apply(function(X) {});
			}
		});

		function U(W) {
			var X = document.getElementById("setting-analysis");
			X.checked = W.isTrackingPermitted();
			X.onchange = function() {
				W.setTrackingPermitted(X.checked);
			};
		}
		tj_service = analytics.getService("enjoyMusic");
		tj_service.getConfig().addCallback(U);
		tj_tracker = tj_service.getTracker("UA-44990884-1");
		tj_tracker.sendAppView("MainView");
		var V = new DnDFileController("body", function(W) {
			var X = W.files[0];
			if (e(X.name)) {
				myaudio.setSrc(window.webkitURL.createObjectURL(X));
				myaudio.play();
				var Y = new Worker("js/add-worker.js");
				Y.postMessage({
					file: X,
					mediaId: null,
					path: null,
					cover: true
				});
				Y.onmessage = function(Z) {
					l.current.track = Z.data;
					l.$apply(function(ab) {});
					var aa = Z.data.picture;
					f(l.current.track);
					if (aa) {
						if (aa.indexOf("/9j/") == -1) {
							$(".cover-img ").attr("src", "data:image/jpeg;base64,/9j/4AAQSkZJRgAB" + aa);
						} else {
							$(".cover-img ").attr("src", "data:image/jpeg;base64," + aa);
						}
					} else {
						$(".cover-img ").attr("src", "images/default_disk.png");
					}
				};
			}
		});
		F();
	}
	I();
}
MusicListCtrl.$inject = ["$scope", "$http"];